<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - ISL Archive</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDoim0HfMd649cWe3wTpLbjiZZP-su6YBU",
            authDomain: "islisl.firebaseapp.com",
            projectId: "islisl",
            storageBucket: "islisl.firebasestorage.app",
            messagingSenderId: "955676281907",
            appId: "1:955676281907:web:808529df880af0aacc2746",
            measurementId: "G-267W98LCC5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Handle login
        async function loginUser(event) {
            event.preventDefault();
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Check if email is verified
                if (user.emailVerified) {
                    window.location.href = '/archive.html'; // Redirect to archive page if email is verified
                } else {
                    alert('Please verify your email before logging in. Check your inbox for a verification email.');
                    // Optionally, you can send another email verification link if desired
                    await sendEmailVerification(user);
                }
            } catch (error) {
                const errorMessage = error.message;
                displayError(errorMessage); // Display error message
            }
        }

        // Handle sign-up
        async function signupUser(event) {
            event.preventDefault();
            const email = document.getElementById("signup-email").value;
            const password = document.getElementById("signup-password").value;
            const displayName = document.getElementById("display-name").value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Set display name after signup
                await updateProfile(user, { displayName: displayName });

                // Send email verification after signup
                await sendEmailVerification(user);
                alert('Sign up successful! Please verify your email.');

                window.location.href = '/login.html'; // Redirect to login page after signup
            } catch (error) {
                const errorMessage = error.message;
                displayError(errorMessage); // Display error message
            }
        }

        // Resend email verification
        async function resendVerificationEmail() {
            const user = auth.currentUser;
            if (user && !user.emailVerified) {
                try {
                    await sendEmailVerification(user);
                    alert("Verification email resent. Please check your inbox.");
                } catch (error) {
                    alert("Error resending verification email: " + error.message);
                }
            } else {
                alert("Your email is already verified or you are not logged in.");
            }
        }

        // Display error message
        function displayError(message) {
            const errorElement = document.getElementById("error-message");
            errorElement.textContent = message;
            errorElement.style.display = "block";
        }

        // Check if the user is already logged in (if they reload the page)
        onAuthStateChanged(auth, (user) => {
            if (user && user.emailVerified) {
                window.location.href = '/archive.html'; // Redirect to archive if user is verified and already logged in
            } else if (user && !user.emailVerified) {
                // Show email verification reminder if user is logged in but email is not verified
                alert('Please verify your email before accessing the site.');
                auth.signOut(); // Optionally sign out if email is not verified
            }
        });

        window.onload = function() {
            document.getElementById("login-form").addEventListener("submit", loginUser);
            document.getElementById("signup-form").addEventListener("submit", signupUser);
        }
    </script>
</head>
<body>
    <h1>Login to ISL Archive</h1>

    <div id="error-message" style="color: red; display: none;"></div>

    <!-- Login Form -->
    <form id="login-form">
        <label for="email">Email:</label>
        <input type="email" id="email" required>
        <br>

        <label for="password">Password:</label>
        <input type="password" id="password" required>
        <br>

        <button type="submit">Login</button>
    </form>

    <p>Don't have an account? <button onclick="showSignupForm()">Sign Up</button></p>

    <!-- Resend Email Verification Button -->
    <button onclick="resendVerificationEmail()">Resend Verification Email</button>

    <!-- Signup Form -->
    <form id="signup-form" style="display: none;">
        <label for="signup-email">Email:</label>
        <input type="email" id="signup-email" required>
        <br>

        <label for="signup-password">Password:</label>
        <input type="password" id="signup-password" required>
        <br>

        <label for="display-name">Display Name:</label>
        <input type="text" id="display-name" required>
        <br>

        <button type="submit">Sign Up</button>
    </form>

    <script>
        // Toggle between Login and Signup forms
        function showSignupForm() {
            document.getElementById("login-form").style.display = "none";
            document.getElementById("signup-form").style.display = "block";
        }
    </script>
</body>
</html>
